<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../casper-epaper/casper-epaper-imports.html">

<dom-module id="casper-epaper">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <canvas width="[[width]]" height="[[height]]"></canvas>
  </template>

  <script>

    Polymer({
      is: 'casper-epaper',
      properties: {
        width: {
          type: Number,
          value: 595
        },
        height: {
          type: Number,
          value: 842
        },
      },

      created: function () {
        this.name = 'papirus';

        this._socket            = new EPaperSocket(this, a_url, a_port, a_uri);
        this._listener          = undefined;
        this._canvas            = a_canvas;
        this._canvas_width      = a_canvas.width;
        this._canvas_height     = a_canvas.height;
        this._scroll_container_ = a_scroll_container;
        this._ctx               = this._canvas.getContext('2d', {alpha: false});
        this._initial_pointer   = this._canvas.style.cursor;
        this._ctx.globalCompositeOperation = 'copy';
        this._page_count        = 0;
        this._page_number       = 1;
        this._message           = '';
        this._r_idx             = 0.0;
        this._bands             = undefined;
        this._document_id       = undefined;
        this._widgets           = [];
        this._images            = {};
        this._widget_under_mice = undefined;
        this._is_focused        = false;
        this._focused_band_id   = undefined;
        this._redraw_timer_key  = '_epaper_redraw_timer_key';
        this.reset_render_state();

        this._page_width  = 595.0;
        this._page_height = 842.0;
        this._grid_major  = 0.0;
        this._grid_minor  = 0.0;

        this._is_socket_open = false;

        // Variables to save the object context
        this._saved_idx         = 0.0;
        this._saved_draw_string = '';

        var devicePixelRatio  = window.devicePixelRatio || 1;
        if (devicePixelRatio > 1.6) {
          devicePixelRatio = 2;
        } else {
          devicePixelRatio = 1;
        }
        var backingStoreRatio = this._ctx.webkitBackingStorePixelRatio ||
                                this._ctx.mozBackingStorePixelRatio ||
                                this._ctx.msBackingStorePixelRatio ||
                                this._ctx.oBackingStorePixelRatio ||
                                this._ctx.backingStorePixelRatio || 1;
        this._ratio = devicePixelRatio / backingStoreRatio;
        console.log("=== devicePixelRatio: " + devicePixelRatio + " backingStoreRatio: " + backingStoreRatio + " ratio: " + this._ratio);

        // ... config assets url and then load the assets ...
        if ( a_asset_url === undefined ) {
          if ( window.location.origin !== undefined ) {
            a_asset_url = window.location.origin;
          } else {
            a_asset_url = window.location.protocol + "//" + window.location.host;
          }
        }
        a_asset_digest = a_asset_digest || '';
        this.load_assets(a_asset_url, a_asset_digest);

        this._edition   = false;
        this._input_box = new EPaperInput(this);

        // ... Install handlers ...
        this._canvas.addEventListener('mousemove', this.create_move_handler(this));
        this._canvas.addEventListener('mousedown', this.create_mouse_down_handler(this));
        this._canvas.addEventListener('mouseup'  , this.create_mouse_up_handler(this));
        this._canvas.addEventListener('focus'    , this.create_focus_handler(this));
        this._canvas.addEventListener('blur'     , this.create_blur_handler(this));
        this._canvas.addEventListener('focusout' , this.create_blur_handler(this));
        this._canvas.addEventListener('paste'    , this.create_html_onpaste_handler(this));
        this._canvas.onkeydown  = this.create_onkeydown_handler(this);
        this._canvas.onkeypress = this.create_onkeypress_handler(this);
        this._canvas.contentEditable = false;

        this._canvas.addEventListener ("textInput", function(a_event) {  }, true );

        // ... clear band tearing control variables ...
        this.reset_band_tearing();

        // ... clear the page before we start ...
        this.setup_scale();

        // ... FOUT Mitigation @TODO proper FOUT mitigation ...
        var styles    = ['', 'bold ', 'italic ', 'italic bold '];
        var y = 175;
        this._ctx.save();
        this._ctx.fillStyle = "#F0F0F0"
        this._ctx.textAlign="center";
        this._font_spec[this.SIZE_INDEX] = 20;
        for ( var i = 0; i < styles.length; i++ ) {
          this._font_spec[this.BOLD_INDEX] = styles[i];
          this._ctx.font = this._font_spec.join('');
          this._ctx.fillText("Powered by Skunk e-Paper", this._canvas.width / 2, y);
          y += 35;
        }
        this._ctx.restore();

        // ... create the overlay widgetery ...
        this.create_line_context_menu();
        this.create_tear_buttons();
        this._input_box._open_combo_button.send_to_front();
        this._input_box._edit_subdocument_button.send_to_front();
      },

      /*
       * Constants
       */
      BTN_SIZE:        24,
      KAPPA:           .5522848,
      BOLD_MASK:       0x01,
      ITALIC_MASK:     0x02,
      UNDERLINE_MASK:  0x04,
      STRIKEOUT_MASK:  0x08,
      BOLD_INDEX:      0,
      ITALIC_INDEX:    1,
      SIZE_INDEX:      2,
      FONT_NAME_INDEX: 4,
      PUNCTURE_HEIGHT: 16,

      ready: function() {
        console.log("Hello my name is " + this.name);
      },

      attached: function() {
        console.log("Hello my name is " + this.name);
      },

    });
  </script>
</dom-module>
